rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ===== Helper Functions =====
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    // ===== Players Collection =====
    match /players/{userId} {
      // READ: Allow authenticated users to read (for leaderboard, profile view)
      allow read: if isAuthenticated();

      // CREATE: Only owner can create their own player doc, with required fields validated.
      allow create: if isAuthenticated()
                     && isOwner(userId)
                     && request.resource.data.keys().hasAll(['name', 'lvl', 'gold', 'dungeon', 'allocated'])
                     && request.resource.data.name is string
                     && request.resource.data.name.size() >= 3
                     && request.resource.data.name.size() <= 15
                     && request.resource.data.lvl is number
                     && request.resource.data.lvl == 1
                     && request.resource.data.gold is number
                     && request.resource.data.gold == 0
                     && request.resource.data.allocated is bool
                     && request.resource.data.allocated == false
                     && request.resource.data.dungeon is map;

      // UPDATE: STRICT - client CANNOT modify gold/lvl/allocated
      allow update: if isAuthenticated()
                     && isOwner(userId)
                     && (
                        !('gold' in request.resource.data && resource.data.gold != request.resource.data.gold)
                        && !('lvl' in request.resource.data && resource.data.lvl != request.resource.data.lvl)
                        && !('allocated' in request.resource.data && resource.data.allocated != request.resource.data.allocated)
                     );

      // DELETE: Only owner can delete
      allow delete: if isAuthenticated()
                     && isOwner(userId);
    }

    // ===== Volume Settings =====
    match /players/{userId}/settings/{document=**} {
      allow read: if isAuthenticated() && isOwner(userId);
      allow write: if isAuthenticated() && isOwner(userId);
    }

    // ===== Deny all other access =====
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
