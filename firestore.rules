rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ===== Users Collection =====
    // NOTE: Storing full player objects in /players documents means any rule that allows
    // authenticated users to read for leaderboard will expose the whole document.
    // PRODUCTION RECOMMENDATION: keep a separate public /publicPlayers collection
    // with only the fields needed for leaderboard (name, gold, lvl, floor) and
    // have server/cloud-functions sign/verify updates to that collection.
    match /players/{userId} {
      // Allow read by authenticated users (used here for simplicity/compatibility).
      // This will expose full player data to any authenticated user.
      allow read: if request.auth != null;

      // Create: only the authenticated user may create their own player doc and it must
      // contain the required fields with basic validation.
      allow create: if request.auth != null
                     && request.auth.uid == userId
                     && request.resource.data.keys().hasAll(['name', 'lvl', 'gold', 'dungeon'])
                     && request.resource.data.name is string
                     && request.resource.data.name.size() > 2
                     && request.resource.data.name.size() < 16
                     && request.resource.data.lvl is number
                     && request.resource.data.lvl >= 1
                     && request.resource.data.lvl <= 500
                     && request.resource.data.gold is number
                     && request.resource.data.gold >= 0
                     && request.resource.data.dungeon is map;

      // Update: DENY all direct updates from client
      // Client must use Cloud Functions (addGold, addLevel, spendGold) instead
      allow update: if false;

      // Delete: only owner can delete their own player
      allow delete: if request.auth != null && request.auth.uid == userId;
    }

    // ===== Volume Settings =====
    match /players/{userId}/settings/{document=**} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // ===== Attendance (Optional for future) =====
    match /players/{userId}/attendance/{attId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // ===== Public Chat Messages =====
    match /chatMessages/{msgId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null &&
                       request.resource.data.userId == request.auth.uid &&
                       request.resource.data.message is string &&
                       request.resource.data.message.size() > 0 &&
                       request.resource.data.message.size() < 500;
      allow delete: if request.auth != null && resource.data.userId == request.auth.uid;
    }

    // ===== Reviews/Feedback =====
    match /reviews/{reviewId} {
      allow read: if true;
      allow create: if request.resource.data.email is string &&
                       request.resource.data.ingame is string &&
                       request.resource.data.rating is number &&
                       request.resource.data.comment is string &&
                       request.resource.data.email.size() > 3 &&
                       request.resource.data.ingame.size() > 2 &&
                       request.resource.data.rating >= 1 &&
                       request.resource.data.rating <= 5 &&
                       request.resource.data.comment.size() > 0 &&
                       request.resource.data.comment.size() < 1000;
      allow update, delete: if false;
    }

    // ===== Deny all other access =====
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
