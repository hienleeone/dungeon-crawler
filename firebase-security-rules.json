{
  "rules": {
    "users": {
      "$uid": {
        ".read": "auth != null && auth.uid == $uid",
        ".write": "auth != null && auth.uid == $uid && (!newData.exists() || (newData.exists() && newData.child('playerData').exists() && newData.child('checksum').exists() && newData.child('lastUpdated').exists() && (!data.exists() || !data.child('lastUpdated').exists() || now - data.child('lastUpdated').val() > 1000)))",
        
        "playerData": {
          ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length < 100000"
        },
        
        "dungeonData": {
          ".validate": "newData.isString() && newData.val().length < 100000"
        },
        
        "enemyData": {
          ".validate": "newData.isString() && newData.val().length < 100000"
        },
        
        "volumeData": {
          ".validate": "newData.isString() && newData.val().length < 10000"
        },
        
        "lastUpdated": {
          ".validate": "newData.isNumber() && newData.val() <= now + 1000"
        },
        
        "checksum": {
          ".validate": "newData.isString() && newData.val().length == 64"
        }
        ,
        "lastChatTime": {
          ".write": "auth != null && auth.uid == $uid",
          ".validate": "newData.isNumber() && newData.val() <= now + 1000"
        }
        ,
        "quickSave": {
          ".write": "auth != null && auth.uid == $uid",
          ".validate": "newData.hasChildren(['gold','lvl','expCurr','expCurrLvl','expMax','expMaxLvl','lastUpdated']) && newData.child('lvl').isNumber() && newData.child('lvl').val() >= 1 && newData.child('expCurr').isNumber() && newData.child('expMax').isNumber() && newData.child('expCurr').val() <= newData.child('expMax').val() && newData.child('expCurrLvl').isNumber() && newData.child('expMaxLvl').isNumber() && newData.child('expCurrLvl').val() <= newData.child('expMaxLvl').val()",
          "gold": { ".validate": "newData.isNumber() && newData.val() >= 0 && (!root.child('config').child('limits').child('goldMax').exists() || newData.val() <= root.child('config').child('limits').child('goldMax').val()) && newData.val() <= 1000000000" },
          "lvl": { ".validate": "newData.isNumber() && newData.val() >= 1 && (!root.child('config').child('limits').child('lvlMax').exists() || newData.val() <= root.child('config').child('limits').child('lvlMax').val()) && newData.val() <= 1000" },
          "expCurr": { ".validate": "newData.isNumber() && newData.val() >= 0 && (!root.child('config').child('limits').child('expCurrMax').exists() || newData.val() <= root.child('config').child('limits').child('expCurrMax').val()) && newData.val() <= 1000000000" },
          "expCurrLvl": { ".validate": "newData.isNumber() && newData.val() >= 0 && (!root.child('config').child('limits').child('expCurrLvlMax').exists() || newData.val() <= root.child('config').child('limits').child('expCurrLvlMax').val()) && newData.val() <= 1000000000" },
          "expMax": { ".validate": "newData.isNumber() && newData.val() >= 0 && (!root.child('config').child('limits').child('expMax').exists() || newData.val() <= root.child('config').child('limits').child('expMax').val()) && newData.val() <= 1000000000" },
          "expMaxLvl": { ".validate": "newData.isNumber() && newData.val() >= 0 && (!root.child('config').child('limits').child('expMaxLvl').exists() || newData.val() <= root.child('config').child('limits').child('expMaxLvl').val()) && newData.val() <= 1000000000" },
          "lastUpdated": { ".validate": "newData.isNumber() && newData.val() <= now + 1000" }
        }
        ,
        "inventoryOps": {
          ".write": "auth != null && auth.uid == $uid",
          "$opId": {
            ".validate": "newData.hasChildren(['op','loc','itemJson','timestamp'])",
            "op": { ".validate": "newData.isString() && (newData.val() == 'sell')" },
            "loc": { ".validate": "newData.isString() && (newData.val() == 'inventory' || newData.val() == 'equipped')" },
            "itemJson": { ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length <= 5000" },
            "timestamp": { ".validate": "newData.isNumber() && newData.val() <= now + 1000" }
          }
        }
      }
    },
    
    "playerNames": {
      ".read": true,
      "$name": {
        ".write": "auth != null && (!data.exists() || (data.exists() && data.val() == auth.uid && !newData.exists()))",
        ".validate": "newData.isString() && newData.val() == auth.uid",
        ".indexOn": ".value"
      }
    },
    
    "leaderboard": {
      ".read": true,
      ".indexOn": ["gold", "level", "floor"],
      "$uid": {
        ".write": "auth != null && auth.uid == $uid",
        
        "name": {
          ".validate": "newData.isString() && newData.val().length >= 3 && newData.val().length <= 15"
        },
        
        "gold": {
          ".validate": "newData.isNumber() && newData.val() >= 0 && (!root.child('config').child('limits').child('leaderboardGoldMax').exists() || newData.val() <= root.child('config').child('limits').child('leaderboardGoldMax').val()) && newData.val() <= 1000000000"
        },
        
        "level": {
          ".validate": "newData.isNumber() && newData.val() >= 1 && (!root.child('config').child('limits').child('leaderboardLevelMax').exists() || newData.val() <= root.child('config').child('limits').child('leaderboardLevelMax').val()) && newData.val() <= 1000"
        },
        
        "floor": {
          ".validate": "newData.isNumber() && newData.val() >= 0 && (!root.child('config').child('limits').child('leaderboardFloorMax').exists() || newData.val() <= root.child('config').child('limits').child('leaderboardFloorMax').val()) && newData.val() <= 100000"
        },
        
        "lastUpdated": {
          ".validate": "newData.isNumber()"
        }
      }
    },
    
    "globalChat": {
      ".read": "auth != null",
      ".indexOn": "timestamp",
      "$messageId": {
        ".write": "auth != null && !data.exists() && newData.child('userId').val() == auth.uid && newData.child('timestamp').val() <= now + 1000 && (!root.child('users').child(auth.uid).child('lastChatTime').exists() || now - root.child('users').child(auth.uid).child('lastChatTime').val() >= 5000)",
        ".validate": "newData.hasChildren(['userId', 'userName', 'userLevel', 'message', 'timestamp'])",
        
        "userId": {
          ".validate": "newData.isString() && newData.val() == auth.uid"
        },
        
        "userName": {
          ".validate": "newData.isString() && newData.val().length >= 3 && newData.val().length <= 15"
        },
        
        "userLevel": {
          ".validate": "newData.isNumber() && newData.val() >= 1 && newData.val() <= 1000"
        },
        
        "message": {
          ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length <= 200"
        },
        
        "timestamp": {
          ".validate": "newData.isNumber()"
        }
      }
    }
    ,
    "admins": {
      "$uid": {
        ".read": "auth != null && auth.uid == $uid",
        ".write": false,
        "allowDevtools": {
          ".validate": "newData.isBoolean()"
        }
      }
    }
  }
}
