{
  "rules": {
    "users": {
      "$uid": {
        ".read": "auth != null && auth.uid == $uid",
        ".write": "auth != null && auth.uid == $uid && (!newData.exists() || (newData.exists() && newData.child('playerData').exists() && newData.child('checksum').exists() && newData.child('lastUpdated').exists() && (!data.exists() || !data.child('lastUpdated').exists() || now - data.child('lastUpdated').val() > 1000)))",
        
        "playerData": {
          ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length < 100000"
        },
        
        "dungeonData": {
          ".validate": "newData.isString() && newData.val().length < 100000"
        },
        
        "enemyData": {
          ".validate": "newData.isString() && newData.val().length < 100000"
        },
        
        "volumeData": {
          ".validate": "newData.isString() && newData.val().length < 10000"
        },
        
        "lastUpdated": {
          ".validate": "newData.isNumber() && newData.val() <= now + 1000"
        },
        
        "checksum": {
          ".validate": "newData.isString() && newData.val().length == 64"
        }
      }
    },
    
    "playerNames": {
      ".read": true,
      "$name": {
        ".write": "auth != null && !data.exists()",
        ".validate": "newData.isString() && newData.val() == auth.uid",
        ".indexOn": ".value"
      }
    },
    
    "leaderboard": {
      ".read": true,
      ".indexOn": ["gold", "level", "floor"],
      "$uid": {
        ".write": "auth != null && auth.uid == $uid",
        
        "name": {
          ".validate": "newData.isString() && newData.val().length >= 3 && newData.val().length <= 15"
        },
        
        "gold": {
          ".validate": "newData.isNumber()"
        },
        
        "level": {
          ".validate": "newData.isNumber()"
        },
        
        "floor": {
          ".validate": "newData.isNumber()"
        },
        
        "lastUpdated": {
          ".validate": "newData.isNumber()"
        }
      }
    },
    
    "globalChat": {
      ".read": "auth != null",
      ".indexOn": "timestamp",
      "$messageId": {
        ".write": "auth != null && !data.exists() && newData.child('userId').val() == auth.uid && newData.child('timestamp').val() <= now + 1000 && (!root.child('users').child(auth.uid).child('lastChatTime').exists() || now - root.child('users').child(auth.uid).child('lastChatTime').val() >= 2000)",
        ".validate": "newData.hasChildren(['userId', 'userName', 'userLevel', 'message', 'timestamp'])",
        
        "userId": {
          ".validate": "newData.isString() && newData.val() == auth.uid"
        },
        
        "userName": {
          ".validate": "newData.isString() && newData.val().length >= 3 && newData.val().length <= 15"
        },
        
        "userLevel": {
          ".validate": "newData.isNumber() && newData.val() >= 1 && newData.val() <= 1000"
        },
        
        "message": {
          ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length <= 200"
        },
        
        "timestamp": {
          ".validate": "newData.isNumber()"
        }
      }
    }
  }
}
